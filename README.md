# Типовые формы для отчетов ППД

## Описание проекта

`Web`-сервис для выгрузки типовых отчетов ППД в рамках решения задач мониторинга разработки месторождений.

## Установка и запуск проекта

1. Склонируйте репозиторий:
```
git clone https://github.com/sidelkin1/ppd_forms
```

2. Активируйте venv и установите зависимости:
```
python -m venv venv
. venv/Scripts/activate
pip install poetry
poetry install --with web,worker,dev --no-root
```

3. Создайте в корневой директории файл `.env` на базе файла `.env.example`

4. Поднимите контейнеры с сервисами и локальной базой данных:
```
docker-compose -f docker-compose-local.yml up -d --build
```

### Особенности работы проекта в контейнерах

* все миграции применяются автоматически
* для автоматического добавления суперюзера в `pgadmin` пропишите в `.env`:
  * PGADMIN_DEFAULT_EMAIL=admin@ya.ru
  * PGADMIN_DEFAULT_PASSWORD=admin
* наружу "проброшены" порты:
  * **5432** - локальная база данных
  * **5050** - админка для базы данных `pgadmin`
  * **6379** - очередь задач на базе `Redis`

## Управление проектом

Сервис будет доступен по следующим адресам:
- http://127.0.0.1:8000/reports - `HTML`-форма для выгрузки отчетов
- http://127.0.0.1:8000/tables - `HTML`-форма для обновления таблиц в локальной БД
- http://127.0.0.1:8000/login - `HTML`-форма для аутентификации пользователя
- http://127.0.0.1:8000/logout - `HTML`-форма для выхода пользователя из системы
- http://127.0.0.1:8000/docs - автоматически сгенерированная документация `Swagger`
- http://127.0.0.1:8000/redoc - автоматически сгенерированная документация `ReDoc`

После запуска доступны следующие эндпоинты:
- Таблицы, загружаемые из базы `OFM`:
    - `POST` **/database/{table}/{mode}** - загрузить таблицу `{table}` в режиме `{mode}`
    - `GET` **/database/{table}** - запросить интервал дат записей в таблице `{table}`
- Таблицы, загружаемые из файлов `Excel`:
    - `POST` **/excel/** - загрузить файл `Excel`
    - `POST` **/excel/{table}/{mode}** - загрузить таблицу `{table}` в режиме `{mode}`
    - `GET` **/excel/{table}** - запросить интервал дат записей в таблице `{table}`
- Выгрузка отчетов:
    - `POST` **/reports/{name}** - запустить процесс выгрузки отчета `{name}`
    - `GET` **/reports/{file_id}** - скачать файл отчета с именем `{file_id}`
    - `DELETE` **/reports/{file_id}** - удалить файл отчета с именем `{file_id}`
- Мониторинг задач:
    - `GET` **/jobs/{job_id}** - получить статус выполнения задачи `{job_id}`
    - **/jobs/{job_id}/ws** - получить статус выполнения задачи `{job_id}` через `WebSocket`
- Активы УН:
    - `GET` **/uneft/fields** - получить список месторождений
    - `GET` **/uneft/fields/{field_id}/reservoirs** - получить список объектов месторождения `{field_id}`
- Аутентификация:
    - `POST` **/auth/token** - получить токен
    - `POST` **/auth/revoke** - отозвать токен
- Пользователи:
    - `GET` **/users/me** - получить информацию о текущем пользователе

## Аутентификация пользователей

Сервис поддерживает два типа аутентификации:

### Базовая аутентификация

Пропишите в `.env`:
  * APP_DEFAULT_USERNAME=user
  * APP_DEFAULT_PASSWORD=password

### Доменная аутентификация (Microsoft AD)

Пропишите в `.env`:
  * LDAP_HOST="example.com"
  * LDAP_PORT=389

## Техническая информация

Стек технологий: `Python` 3.11, `FastAPI`, `PostgreSQL`, `Redis`, `WebSocket`.
